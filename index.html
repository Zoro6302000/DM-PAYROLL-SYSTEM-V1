<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D.M. MALIWANAG BUILDERS AND ENTERPRISES - Payroll System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { margin:0; font-size:32px; font-weight:bold; text-align:left; }
    h2 { margin:0; font-size:24px; font-weight:normal; text-align:center; }
    .by { text-align:center; font-size:16px; margin-bottom:15px; }
    .date { text-align: center; margin: 20px 0; font-weight: bold; }
    nav { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background: #333; color: #fff; }
    input, select { padding: 4px; }
    input[type=text] { text-transform: uppercase; width: 250px; }
    input[type=number] { width: 100px; text-align: center; }
    .nameInput { width: 100%; min-width:200px; text-transform: uppercase; box-sizing: border-box; }
    button {
      padding: 10px 18px;
      background: linear-gradient(90deg, #004aad, #0073e6);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }
    button.small { padding: 4px 8px; border-radius:6px; font-weight:600; }
    button:hover { background: linear-gradient(90deg, #0073e6, #004aad); transform: translateY(-2px); }
    .danger { background:#e53935; }
    .danger:hover { background:#c62828; }
    .hidden { display: none; }
    #summary { margin-top: 30px; background: #fff; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div style="display:flex;align-items:center;justify-content:center;gap:15px;">
    <img src="DM LOGO.png" alt="Company Logo" style="height:120px;">
    <div>
      <h1>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h1>
    </div>
  </div>

  <div style="text-align:center;margin-top:5px;">
    <h2 style="margin:5px 0;font-size:30px;">Payroll System</h2>
    <div style="font-size:12px;">by: Wenjunzxc</div>
  </div>

  <div class="date">
    Payroll Period:
    <input type="date" id="payrollFrom"> to
    <input type="date" id="payrollTo">
  </div>

  <nav>
    <button onclick="showInterface('dashboard')">Dashboard</button>
    <button onclick="showInterface('site')">Per Site Payroll</button>
    <button onclick="addNewSite()">Add New Site</button>
  </nav>

  <div id="dashboardInterface">
    <h2 style="text-align:center;">Welcome to the Payroll System</h2>
    <p style="text-align:center;">This dashboard provides an overview of all projects and payroll summaries.</p>
    <div id="summary">
      <h3>Payroll Summary by Site</h3>
      <table id="siteSummary">
        <thead>
          <tr>
            <th>Site</th>
            <th>Total Gross</th>
            <th>Total Deductions</th>
            <th>Total Net</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>GRAND TOTAL</th>
            <th id="grandGross">₱0</th>
            <th id="grandDeductions">₱0</th>
            <th id="grandNet">₱0</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
      <br>
      <button onclick="printSummary()">Print Payroll Summary</button>
      <button onclick="exportCSV()">Export Payroll to CSV</button>
    </div>
  </div>

  <div id="siteInterface" class="hidden">
    <label for="perSiteSelect"><strong>Select Site:</strong></label>
    <select id="perSiteSelect" onchange="renderSiteTable(); localStorage.setItem('lastSite', this.value);"></select>
    <button onclick="addEmployeeToSite()">Add Employee to This Site</button>
    <button onclick="deleteSite()">Delete Site</button>
    <button onclick="printSitePayroll()">Print This Site Payroll</button>

    <div id="sitePayrollArea">
      <table id="perSiteTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Rate/Day</th>
            <th>Days Worked</th>
            <th>OT Hours</th>
            <th>Gross Pay</th>
            <th>Cash Advance</th>
            <th>Benefits</th>
            <th>Net Pay</th>
            <th>Signature</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br>
      <div id="perSiteSummary">
        <h3>Summary for Selected Site</h3>
        <table>
          <thead>
            <tr>
              <th>Total Gross</th>
              <th>Total Deductions</th>
              <th>Total Net</th>
            </tr>
          </thead>
          <tbody id="perSiteSummaryBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let siteTotals = {};
    let sites = [];
    let siteData = {};

    // rounding helpers
    function round0(n){ return Math.round(Number(n)||0); }
    function pesoFormat(num){
      return "₱" + (round0(num)).toLocaleString("en-PH",{minimumFractionDigits:0, maximumFractionDigits:0});
    }
    // printing helper: show "-" for zero amounts
    function printPeso(num){
      return round0(num) === 0 ? "-" : pesoFormat(num);
    }

    // persistence helpers
    function saveData(){
      try{
        localStorage.setItem("sites", JSON.stringify(sites));
        localStorage.setItem("siteData", JSON.stringify(siteData));
        localStorage.setItem("payrollFrom", document.getElementById("payrollFrom").value || "");
        localStorage.setItem("payrollTo", document.getElementById("payrollTo").value || "");
      }catch(e){ console.error("Save failed", e); }
    }
    function loadData(){
      try{
        const savedSites = localStorage.getItem("sites");
        const savedSiteData = localStorage.getItem("siteData");
        const from = localStorage.getItem("payrollFrom");
        const to = localStorage.getItem("payrollTo");
        const lastSite = localStorage.getItem("lastSite");

        if(from) document.getElementById("payrollFrom").value = from;
        if(to) document.getElementById("payrollTo").value = to;

        if(savedSites && savedSiteData){
          sites = JSON.parse(savedSites) || [];
          siteData = JSON.parse(savedSiteData) || {};
        }

        const select = document.getElementById("perSiteSelect");
        select.innerHTML = "";
        sites.forEach(s=>{
          const opt=document.createElement("option");
          opt.value=s; opt.textContent=s; select.appendChild(opt);
        });

        if(sites.length){
          select.value = lastSite && sites.includes(lastSite) ? lastSite : sites[0];
        }

        computePayroll();
        renderSiteTable();
      }catch(e){ console.error("Load failed", e); }
    }
    document.addEventListener("DOMContentLoaded", loadData);
    window.addEventListener("beforeunload", saveData);

    document.getElementById("payrollFrom").addEventListener("change", ()=>{ saveData(); computePayroll(); });
    document.getElementById("payrollTo").addEventListener("change", ()=>{ saveData(); computePayroll(); });

    function getMaxDays() {
      const from=document.getElementById("payrollFrom").value;
      const to=document.getElementById("payrollTo").value;
      if(from && to){
        const start=new Date(from);const end=new Date(to);
        return Math.floor((end-start)/(1000*60*60*24))+1;
      }
      return 0;
    }

    function showInterface(mode){
      document.getElementById("dashboardInterface").classList.add("hidden");
      document.getElementById("siteInterface").classList.add("hidden");
      if(mode==="dashboard"){document.getElementById("dashboardInterface").classList.remove("hidden");computePayroll();}
      else {document.getElementById("siteInterface").classList.remove("hidden");renderSiteTable();}
    }

    function addNewSite(){
      const input = prompt("Enter new site name:");
      if(!input) return;
      const siteName = input.toUpperCase();
      if(!sites.includes(siteName)){
        sites.push(siteName);
        const select=document.getElementById("perSiteSelect");
        const option=document.createElement("option");
        option.value=siteName;
        option.textContent=siteName;
        select.appendChild(option);
        siteData[siteName]=[];
        select.value=siteName;
        localStorage.setItem('lastSite', siteName);
        renderSiteTable();
        computePayroll();
        saveData();
      } else {
        alert("Site already exists.");
        document.getElementById("perSiteSelect").value=siteName;
        localStorage.setItem('lastSite', siteName);
        renderSiteTable();
      }
    }

    function deleteSite(){
      const select=document.getElementById("perSiteSelect");
      const siteName=select.value;
      if(!siteName){alert("Please select a site to delete.");return;}
      if(confirm("Delete site: "+siteName+" ?")){
        sites=sites.filter(s=>s!==siteName);
        delete siteData[siteName];
        [...select.options].forEach(opt=>{if(opt.value===siteName) opt.remove();});
        if(sites.length){
          select.value = sites[0];
          localStorage.setItem('lastSite', sites[0]);
        }else{
          select.value = "";
          localStorage.removeItem('lastSite');
        }
        document.querySelector("#perSiteTable tbody").innerHTML="";
        document.getElementById("perSiteSummaryBody").innerHTML="";
        computePayroll();
        saveData();
        alert("Site deleted.");
      }
    }

    function addEmployeeToSite(){
      const site=document.getElementById("perSiteSelect").value;
      if(!site){alert("Please add or select a site first.");return;}
      if(!siteData[site]) siteData[site]=[];
      siteData[site].push({name:"",rate:"",days:"",ot:"",gross:0,advance:"",benefits:"",net:0});
      renderSiteTable();
      computePayroll();
      saveData();
    }

    function deleteEmployee(site, idx){
      if(!siteData[site]) return;
      if(!confirm("Delete this employee?")) return;
      siteData[site].splice(idx,1);
      renderSiteTable();
      computePayroll();
      saveData();
    }

    function renderSiteTable(){
      const site=document.getElementById("perSiteSelect").value;
      const tbody=document.querySelector("#perSiteTable tbody");
      tbody.innerHTML="";
      if(!site||!siteData[site]) return;

      siteData[site].forEach((emp,idx)=>{
        const rate = Number(emp.rate)||0;
        const days = Number(emp.days)||0;
        const otH  = Number(emp.ot)||0;
        const otPay = round0((otH * rate) / 8);
        const gross = round0(rate * days + otPay);
        const deductions = round0((Number(emp.advance)||0) + (Number(emp.benefits)||0));
        const net = round0(gross - deductions);
        emp.gross=gross; emp.net=net;

        const row=document.createElement("tr");
        row.innerHTML=`
          <td><input type="text" class="nameInput" style="width:auto;min-width:200px;" value="${emp.name||""}"
            oninput="this.value=this.value.toUpperCase(); updateEmployee('${site}',${idx},'name',this.value)"
            onkeydown="focusNext(event,this)" placeholder="NAME"></td>
          <td><input type="number" value="${emp.rate?emp.rate:''}" class="rate" step="0.01"
            oninput="updateEmployee('${site}',${idx},'rate',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td><input type="number" value="${emp.days?emp.days:''}" class="days" step="0.5"
            onblur="validateHalfStep(this,'${site}',${idx},'days')"
            onkeydown="focusNext(event,this)" placeholder="Days (Max ${getMaxDays()})"></td>
          <td><input type="number" value="${emp.ot?emp.ot:''}" class="ot" step="0.5"
            onblur="validateHalfStep(this,'${site}',${idx},'ot')"
            onkeydown="focusNext(event,this)" placeholder="OT"></td>
          <td class="gross">${pesoFormat(emp.gross)}</td>
          <td><input type="number" value="${emp.advance?emp.advance:''}" class="advance" step="0.01"
            oninput="updateEmployee('${site}',${idx},'advance',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td><input type="number" value="${emp.benefits?emp.benefits:''}" class="benefits" step="0.01"
            oninput="updateEmployee('${site}',${idx},'benefits',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td class="net">${pesoFormat(emp.net)}</td>
          <td style="height:40px;"></td>
          <td>
            <button class="small danger" onclick="deleteEmployee('${site}',${idx})">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      if(site) localStorage.setItem('lastSite', site);

      computePayroll();
      saveData();
    }

    function focusNext(e,input){
      if(e.key==="Enter"){
        e.preventDefault();
        let inputs=Array.from(input.closest("tr").querySelectorAll("input,select"));
        let idx=inputs.indexOf(input);
        if(idx>=0 && idx<inputs.length-1){inputs[idx+1].focus();}
        else{input.blur();}
        computePayroll();
        saveData();
      }
    }

    function validateHalfStep(input, site, idx, field){
      let raw=input.value;
      if(raw===".") raw="0.5";
      else if(raw.startsWith(".")&&raw.length>1){raw="0"+raw;}
      let val=parseFloat(raw)||0;
      const maxDays=getMaxDays();
      val=Math.round(val*2)/2;
      if(val<0) val=0;
      if(field==="days"&&maxDays>0&&val>maxDays){
        alert("Days worked cannot exceed ("+maxDays+") days.");
        val=maxDays;
      }
      input.value=val||"";
      siteData[site][idx][field]=val;
      computePayroll();
      saveData();
    }

    function updateEmployee(site,idx,field,value){
      let num=parseFloat(value);
      if(isNaN(num)) num=0;
      if(["advance","benefits","rate"].includes(field)&&num<0) num=0;
      siteData[site][idx][field]=(field==="name"?value:num);
      computePayroll();
      saveData();
    }

    function computePayroll(){
      siteTotals={};
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          const rate = Number(emp.rate)||0;
          const days = Number(emp.days)||0;
          const otH  = Number(emp.ot)||0;
          const otPay = round0((otH * rate) / 8);
          const gross = round0(rate * days + otPay);
          const deductions = round0((Number(emp.advance)||0) + (Number(emp.benefits)||0));
          const net = round0(gross - deductions);
          emp.gross=gross; emp.net=net;

          if(!siteTotals[site]) siteTotals[site]={gross:0,deductions:0,net:0};
          siteTotals[site].gross = round0(siteTotals[site].gross + gross);
          siteTotals[site].deductions = round0(siteTotals[site].deductions + deductions);
          siteTotals[site].net = round0(siteTotals[site].net + net);
        });
      }
      updateDashboardSummary();
      updatePerSiteSummary();
      refreshTables();
    }

    function refreshTables(){
      const site=document.getElementById("perSiteSelect").value;
      if(site&&siteData[site]){
        const rows=document.querySelectorAll("#perSiteTable tbody tr");
        rows.forEach((row,idx)=>{
          row.querySelector(".gross").textContent=pesoFormat(siteData[site][idx].gross||0);
          row.querySelector(".net").textContent=pesoFormat(siteData[site][idx].net||0);
        });
      }
    }

    function updateDashboardSummary(){
      const tbody=document.querySelector("#siteSummary tbody");
      tbody.innerHTML="";
      let gGross=0,gDed=0,gNet=0;
      for(let site in siteTotals){
        tbody.innerHTML+=`<tr>
          <td>${site}</td>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
          <td style="height:40px;"></td>
        </tr>`;
        gGross = round0(gGross + siteTotals[site].gross);
        gDed   = round0(gDed + siteTotals[site].deductions);
        gNet   = round0(gNet + siteTotals[site].net);
      }
      document.getElementById("grandGross").textContent=pesoFormat(gGross);
      document.getElementById("grandDeductions").textContent=pesoFormat(gDed);
      document.getElementById("grandNet").textContent=pesoFormat(gNet);
    }

    function updatePerSiteSummary(){
      const site=document.getElementById("perSiteSelect").value;
      const tbody=document.getElementById("perSiteSummaryBody");
      tbody.innerHTML="";
      if(siteTotals[site]){
        tbody.innerHTML=`<tr>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
        </tr>`;
      }
    }

    // dashboard printing, "-" for zero amounts
    function printSummary(){
      computePayroll();
      const sitesList = Object.keys(siteTotals || {});
      if(sitesList.length === 0){ alert("No data to print."); return; }

      let bodyRows = "";
      let gGross=0, gDed=0, gNet=0;

      sitesList.forEach(site=>{
        const t = siteTotals[site] || {gross:0,deductions:0,net:0};
        gGross = round0(gGross + t.gross);
        gDed   = round0(gDed + t.deductions);
        gNet   = round0(gNet + t.net);
        bodyRows += `<tr>
          <td>${site}</td>
          <td class="num">${printPeso(t.gross)}</td>
          <td class="num">${printPeso(t.deductions)}</td>
          <td class="num">${printPeso(t.net)}</td>
          <td></td>
        </tr>`;
      });

      const from = document.getElementById("payrollFrom").value || "";
      const to   = document.getElementById("payrollTo").value || "";
      const printed = new Date().toLocaleDateString("en-PH");

      const win = window.open("", "_blank");
      win.document.write(`<html>
<head>
  <title>Payroll Summary</title>
  <style>
    @page { size: A4; margin: 12mm; }
    @media print {
      body { margin: 0; font-family: Arial, sans-serif; font-size: 12px; }
      h2, h3 { margin: 4px 0; text-align: center; }
      .meta { text-align: center; margin: 6px 0 10px; }
      table { border-collapse: collapse; width: 100%; margin-top: 8px; }
      th, td { border: 1px solid #000; padding: 6px; }
      th { background: #000; color: #fff; }
      td.num, th.num { text-align: right; }
      tfoot th { text-align: right; }
      .sig { margin-top: 24px; display: flex; gap: 40px; justify-content: space-between; }
      .sig div { width: 48%; text-align: center; }
      .sig u { display: inline-block; min-width: 220px; }
    }
  </style>
</head>
<body>
  <h2>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h2>
  <h3>Payroll Summary by Site</h3>
  <div class="meta">
    Payroll Period: ${from} to ${to} • Printed: ${printed}
  </div>

  <table>
    <thead>
      <tr>
        <th>Site</th>
        <th class="num">Total Gross</th>
        <th class="num">Total Deductions</th>
        <th class="num">Total Net</th>
        <th>Remarks</th>
      </tr>
    </thead>
    <tbody>${bodyRows}</tbody>
    <tfoot>
      <tr>
        <th>GRAND TOTAL</th>
        <th class="num">${printPeso(gGross)}</th>
        <th class="num">${printPeso(gDed)}</th>
        <th class="num">${printPeso(gNet)}</th>
        <th></th>
      </tr>
    </tfoot>
  </table>

  <div class="sig">
    <div>Prepared by:<br><br><u>${(localStorage.getItem("preparedBy")||"")}</u><br>Signature over printed name</div>
    <div>Approved by:<br><br><u>DANA MALIWANAG</u><br>Signature over printed name</div>
  </div>
</body>
</html>`);
      win.print();
      win.close();
    }

    // per-site printing, "-" for zero amounts
    function printSitePayroll(){
      const site = document.getElementById("perSiteSelect").value;
      if(!site){ alert("Please select a site first."); return; }
      computePayroll();

      const list = Array.isArray(siteData[site]) ? siteData[site] : [];
      if(list.length === 0){ alert("No employees in this site."); return; }

      let bodyRows = "";
      list.forEach(emp=>{
        const rate = Number(emp.rate)||0;
        const days = Number(emp.days)||0;
        const otH  = Number(emp.ot)||0;
        const otPay = round0((otH * rate) / 8);
        const gross = round0(rate * days + otPay);
        const adv   = round0(Number(emp.advance)||0);
        const ben   = round0(Number(emp.benefits)||0);
        const net   = round0(gross - round0(adv+ben));

        bodyRows += `<tr>
          <td class="nameCol">${emp.name||""}</td>
          <td>${printPeso(rate)}</td>
          <td>${days}</td>
          <td>${otH}</td>
          <td>${printPeso(gross)}</td>
          <td>${printPeso(adv)}</td>
          <td>${printPeso(ben)}</td>
          <td>${printPeso(net)}</td>
          <td></td>
        </tr>`;
      });

      const totals = list.reduce((a,e)=>{
        const rate = Number(e.rate)||0;
        const days = Number(e.days)||0;
        const otH  = Number(e.ot)||0;
        const otPay = round0((otH * rate) / 8);
        const gross = round0(rate * days + otPay);
        const adv   = round0(Number(e.advance)||0);
        const ben   = round0(Number(e.benefits)||0);
        const net   = round0(gross - round0(adv+ben));
        return {
          gross: round0(a.gross + gross),
          advance: round0(a.advance + adv),
          benefits: round0(a.benefits + ben),
          net: round0(a.net + net)
        };
      }, {gross:0, advance:0, benefits:0, net:0});

      bodyRows += `<tr>
        <td colspan="4"><strong>Total</strong></td>
        <td><strong>${printPeso(totals.gross)}</strong></td>
        <td><strong>${printPeso(totals.advance)}</strong></td>
        <td><strong>${printPeso(totals.benefits)}</strong></td>
        <td><strong>${printPeso(totals.net)}</strong></td>
        <td></td>
      </tr>`;

      const win = window.open("", "_blank");
      win.document.write(`<html>
<head>
  <title>${site} Payroll</title>
  <style>
    @media print {
      body { margin: 10px; font-family: Arial, sans-serif; }
      h2, h3 { margin: 5px 0; text-align: center; }
      table { border-collapse: collapse; width: 100%; margin-top: 10px; }
      th, td { border: 1px solid #000; padding: 5px; text-align: center; }
      th.nameCol, td.nameCol { white-space: nowrap; word-break: keep-all; hyphens: none; }
    }
  </style>
</head>
<body>
  <h2>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h2>
  <h3>Payroll Report - ${site}</h3>
  <h3>Payroll Period: ${document.getElementById("payrollFrom").value} to ${document.getElementById("payrollTo").value}</h3>
  <table>
    <thead>
      <tr>
        <th class="nameCol">Name</th><th>Rate/Day</th><th>Days Worked</th><th>OT Hours</th>
        <th>Gross Pay</th><th>Cash Advance</th><th>Benefits</th><th>Net Pay</th><th>Signature</th>
      </tr>
    </thead>
    <tbody>${bodyRows}</tbody>
  </table>
  <br>
  <div style="margin-top:20px;">Approved by:<br><br><u>DANA MALIWANAG</u><br>Signature over printed name</div>
</body>
</html>`);
      win.print();
      win.close();
    }

    function exportCSV(){
      computePayroll();
      let csv="Site,Name,Rate,Days Worked,OT Hours,Gross,Cash Advance,Benefits,Net\n";
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          csv+=`${site},${emp.name},${round0(emp.rate)},${emp.days},${emp.ot},${round0(emp.gross)},${round0(emp.advance)},${round0(emp.benefits)},${round0(emp.net)}\n`;
        });
      }
      const blob=new Blob([csv],{type:"text/csv"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="payroll.csv";
      link.click();
    }
  </script>
</body>
</html>
