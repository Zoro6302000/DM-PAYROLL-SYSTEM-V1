<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D.M. MALIWANAG BUILDERS AND ENTERPRISES - Payroll System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { margin:0; font-size:32px; font-weight:bold; text-align:left; }
    h2 { margin:0; font-size:24px; font-weight:normal; text-align:center; }
    .date { text-align: center; margin: 16px 0; font-weight: bold; }
    .sigs-bar { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-bottom:10px; }
    .sigs-bar label { font-size:12px; font-weight:bold; }
    .sigs-bar input { padding:4px 6px; width:220px; text-transform:uppercase; }
    nav { text-align: center; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background: #333; color: #fff; }
    input, select { padding: 4px; }
    input[type=text] { text-transform: uppercase; width: 240px; }
    input[type=number] { width: 100px; text-align: center; }
    .nameInput { width: 100%; min-width:200px; text-transform: uppercase; box-sizing: border-box; }
    button { padding: 10px 16px; background: linear-gradient(90deg, #004aad, #0073e6); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 4px; }
    button.small { padding: 4px 8px; border-radius:6px; font-weight:600; }
    button:hover { background: linear-gradient(90deg, #0073e6, #004aad); }
    .danger { background:#e53935; }
    .danger:hover { background:#c62828; }
    .hidden { display:none; }
    #summary { margin-top: 18px; background: #fff; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div style="display:flex;align-items:center;justify-content:center;gap:15px;">
    <img id="mainLogo" src="DM%20LOGO.png" alt="Company Logo" style="height:150px;">
    <div><h1>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h1></div>
  </div>

  <div style="text-align:center;margin-top:5px;">
    <h2 style="margin:5px 0;font-size:30px;">Payroll System</h2>
    <div style="font-size:12px;">by: Wenjunzxc</div>
  </div>

  <div class="date">
    Payroll Period:
    <input type="date" id="payrollFrom"> to
    <input type="date" id="payrollTo">
  </div>

  <div class="sigs-bar">
    <label>Prepared by:</label>
    <input id="preparedByInput" type="text" placeholder="TYPE NAME">
    <label>Checked by:</label>
    <input id="checkedByInput" type="text" placeholder="TYPE NAME">
    <label>Approved by:</label>
    <input id="approvedByInput" type="text" value="DANA MALIWANAG">
  </div>

  <nav>
    <button onclick="showInterface('dashboard')">Dashboard</button>
    <button onclick="showInterface('site')">Per Site Payroll</button>
    <button onclick="addNewSite()">Add New Site</button>
  </nav>

  <!-- DASHBOARD -->
  <div id="dashboardInterface">
    <h2 style="text-align:center;">Welcome to the Payroll System</h2>
    <p style="text-align:center;">Overview of projects and payroll summaries.</p>
    <div id="summary">
      <h3>Payroll Summary by Site</h3>
      <table id="siteSummary">
        <thead>
          <tr>
            <th>Site</th>
            <th>Total Gross</th>
            <th>Total Deductions</th>
            <th>Total Net</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>GRAND TOTAL</th>
            <th id="grandGross">₱0</th>
            <th id="grandDeductions">₱0</th>
            <th id="grandNet">₱0</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
      <br>
      <button onclick="printSummary()">Print Summary</button>
    </div>
  </div>

  <!-- PER SITE -->
  <div id="siteInterface" class="hidden">
    <label for="perSiteSelect"><strong>Select Site:</strong></label>
    <select id="perSiteSelect" onchange="renderSiteTable(); localStorage.setItem('lastSite', this.value);"></select>
    <button onclick="addEmployeeToSite()">Add Employee</button>
    <button onclick="deleteSite()">Delete Site</button>
    <button onclick="printSitePayroll()">Print</button>
    <button onclick="triggerCSV()">Import</button>
    <button onclick="downloadTemplate()">Template</button>
    <input id="csvFile" type="file" accept=".csv" class="hidden">

    <div id="sitePayrollArea">
      <table id="perSiteTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Role</th>
            <th>Rate/Day</th>
            <th>Days Worked</th>
            <th>PAY BEFORE OT</th>
            <th>OT Hours</th>
            <th>OT PAY</th>
            <th>Gross Pay</th>
            <th>Cash Advance</th>
            <th>Benefits</th>
            <th>Net Pay</th>
            <th>Signature</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br>
      <div id="perSiteSummary">
        <h3>Summary for Selected Site</h3>
        <table>
          <thead>
            <tr>
              <th>Total Gross</th>
              <th>Total Deductions</th>
              <th>Total Net</th>
            </tr>
          </thead>
          <tbody id="perSiteSummaryBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Role order updated: FOREMAN, SKILLED, SEMI-SKILLED, LABOR, CHECKER, TULOG, BANTAY
    const ROLE_OPTIONS = ["FOREMAN","SKILLED","SEMI-SKILLED","LABOR","CHECKER","TULOG","BANTAY"];

    let siteTotals = {};
    let sites = [];
    let siteData = {};

    function round0(n){ return Math.round(Number(n)||0); }
    function pesoFormat(num){ return "₱" + (round0(num)).toLocaleString("en-PH",{minimumFractionDigits:0, maximumFractionDigits:0}); }
    function printPeso(num){ return round0(num) === 0 ? "-" : pesoFormat(num); }
    function cleanRole(v){
      if(!v) return "LABOR";
      let s = String(v).trim().toUpperCase().replace(/\s+/g," ");
      if(s==="SEMI SKILLED" || s==="SEMISKILLED") s="SEMI-SKILLED";
      if(ROLE_OPTIONS.includes(s)) return s;
      return "LABOR";
    }
    function getLogoSrc(){
      const img = document.getElementById("mainLogo");
      const raw = (img && (img.getAttribute("src") || img.src)) || "DM%20LOGO.png";
      try { return new URL(raw, window.location.href).href; }
      catch { return (raw + ""); }
    }

    document.addEventListener("DOMContentLoaded", loadData);
    window.addEventListener("beforeunload", saveData);

    document.getElementById("payrollFrom").addEventListener("change", ()=>{ saveData(); computePayroll(); });
    document.getElementById("payrollTo").addEventListener("change", ()=>{ saveData(); computePayroll(); });
    document.getElementById("preparedByInput").addEventListener("input", saveData);
    document.getElementById("checkedByInput").addEventListener("input", saveData);
    document.getElementById("approvedByInput").addEventListener("input", saveData);

    document.getElementById("csvFile").addEventListener("change", handleCSVChange);
    function triggerCSV(){ document.getElementById("csvFile").click(); }
    function downloadTemplate(){
      const csv = "Name,Role,Rate/Day\nJUAN DELA CRUZ,SKILLED,550\nANA SANTOS,CHECKER,500\nPEDRO PENDUKO,BANTAY,450\nMARIA CLARA,LABOR,600\n";
      const blob = new Blob([csv], {type:"text/csv"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "employees_template.csv";
      link.click();
    }

    function saveData(){
      try{
        localStorage.setItem("sites", JSON.stringify(sites));
        localStorage.setItem("siteData", JSON.stringify(siteData));
        localStorage.setItem("payrollFrom", document.getElementById("payrollFrom").value || "");
        localStorage.setItem("payrollTo", document.getElementById("payrollTo").value || "");
        localStorage.setItem("preparedBy", (document.getElementById("preparedByInput").value||"").toUpperCase());
        localStorage.setItem("checkedBy", (document.getElementById("checkedByInput").value||"").toUpperCase());
        localStorage.setItem("approvedBy", (document.getElementById("approvedByInput").value||"").toUpperCase());
      }catch(e){ console.error("Save failed", e); }
    }
    function loadData(){
      try{
        const savedSites = localStorage.getItem("sites");
        const savedSiteData = localStorage.getItem("siteData");
        const from = localStorage.getItem("payrollFrom");
        const to = localStorage.getItem("payrollTo");
        const lastSite = localStorage.getItem("lastSite");

        if(from) document.getElementById("payrollFrom").value = from;
        if(to) document.getElementById("payrollTo").value = to;

        if(savedSites && savedSiteData){
          sites = JSON.parse(savedSites) || [];
          siteData = JSON.parse(savedSiteData) || {};
        }

        document.getElementById("preparedByInput").value = (localStorage.getItem("preparedBy")||"");
        document.getElementById("checkedByInput").value  = (localStorage.getItem("checkedBy")||"");
        document.getElementById("approvedByInput").value = (localStorage.getItem("approvedBy")||"DANA MALIWANAG");

        const select = document.getElementById("perSiteSelect");
        select.innerHTML = "";
        sites.forEach(s=>{
          const opt=document.createElement("option");
          opt.value=s; opt.textContent=s; select.appendChild(opt);
        });

        if(sites.length){
          select.value = lastSite && sites.includes(lastSite) ? lastSite : sites[0];
        }

        computePayroll();
        renderSiteTable();
      }catch(e){ console.error("Load failed", e); }
    }

    function getMaxDays() {
      const from=document.getElementById("payrollFrom").value;
      const to=document.getElementById("payrollTo").value;
      if(from && to){
        const start=new Date(from);const end=new Date(to);
        return Math.floor((end-start)/(1000*60*60*24))+1;
      }
      return 0;
    }

    function showInterface(mode){
      document.getElementById("dashboardInterface").classList.add("hidden");
      document.getElementById("siteInterface").classList.add("hidden");
      if(mode==="dashboard"){document.getElementById("dashboardInterface").classList.remove("hidden");computePayroll();}
      else {document.getElementById("siteInterface").classList.remove("hidden");renderSiteTable();}
    }

    function addNewSite(){
      const input = prompt("Enter new site name:");
      if(!input) return;
      const siteName = input.toUpperCase();
      if(!sites.includes(siteName)){
        sites.push(siteName);
        const select=document.getElementById("perSiteSelect");
        const option=document.createElement("option");
        option.value=siteName;
        option.textContent=siteName;
        select.appendChild(option);
        siteData[siteName]=[];
        select.value=siteName;
        localStorage.setItem('lastSite', siteName);
        renderSiteTable();
        computePayroll();
        saveData();
      } else {
        alert("Site already exists.");
        document.getElementById("perSiteSelect").value=siteName;
        localStorage.setItem('lastSite', siteName);
        renderSiteTable();
      }
    }

    function deleteSite(){
      const select=document.getElementById("perSiteSelect");
      const siteName=select.value;
      if(!siteName){alert("Please select a site to delete.");return;}
      if(confirm("Delete site: "+siteName+" ?")){
        sites=sites.filter(s=>s!==siteName);
        delete siteData[siteName];
        [...select.options].forEach(opt=>{if(opt.value===siteName) opt.remove();});
        if(sites.length){
          select.value = sites[0];
          localStorage.setItem('lastSite', sites[0]);
        }else{
          select.value = "";
          localStorage.removeItem('lastSite');
        }
        document.querySelector("#perSiteTable tbody").innerHTML="";
        document.getElementById("perSiteSummaryBody").innerHTML="";
        computePayroll();
        saveData();
        alert("Site deleted.");
      }
    }

    function addEmployeeToSite(){
      const site=document.getElementById("perSiteSelect").value;
      if(!site){alert("Please add or select a site first.");return;}
      if(!siteData[site]) siteData[site]=[];
      siteData[site].push({name:"",role:"LABOR",rate:"",days:"",ot:"",basePay:0,otPay:0,gross:0,advance:"",benefits:"",net:0});
      renderSiteTable();
      computePayroll();
      saveData();
    }

    function deleteEmployee(site, idx){
      if(!siteData[site]) return;
      if(!confirm("Delete this employee?")) return;
      siteData[site].splice(idx,1);
      renderSiteTable();
      computePayroll();
      saveData();
    }

    function renderSiteTable(){
      const site=document.getElementById("perSiteSelect").value;
      const tbody=document.querySelector("#perSiteTable tbody");
      tbody.innerHTML="";
      if(!site||!siteData[site]) return;

      siteData[site].forEach((emp,idx)=>{
        const role = cleanRole(emp.role||"LABOR");
        emp.role = role;

        const rate = Number(emp.rate)||0;
        const days = Number(emp.days)||0;
        const otH  = Number(emp.ot)||0;

        const basePay = round0(rate * days);
        const otPay   = round0((otH * rate) / 8);
        const gross   = round0(basePay + otPay);
        const deductions = round0((Number(emp.advance)||0) + (Number(emp.benefits)||0));
        const net = round0(gross - deductions);

        emp.basePay=basePay; emp.otPay=otPay; emp.gross=gross; emp.net=net;

        const roleSelect = `<select onchange="updateEmployee('${site}',${idx},'role',this.value)">
          ${ROLE_OPTIONS.map(opt=>`<option value="${opt}" ${opt===role?'selected':''}>${opt}</option>`).join('')}
        </select>`;

        const row=document.createElement("tr");
        row.innerHTML=`
          <td><input type="text" class="nameInput" style="width:auto;min-width:200px;" value="${emp.name||""}"
            oninput="this.value=this.value.toUpperCase(); updateEmployee('${site}',${idx},'name',this.value)"
            onkeydown="focusNext(event,this)" placeholder="NAME"></td>
          <td>${roleSelect}</td>
          <td><input type="number" value="${emp.rate?emp.rate:''}" class="rate" step="0.01"
            oninput="updateEmployee('${site}',${idx},'rate',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td><input type="number" value="${emp.days?emp.days:''}" class="days" step="0.5"
            onblur="validateHalfStep(this,'${site}',${idx},'days')"
            onkeydown="focusNext(event,this)" placeholder="Days (Max ${getMaxDays()})"></td>
          <td class="basepay">${pesoFormat(emp.basePay)}</td>
          <td><input type="number" value="${emp.ot?emp.ot:''}" class="ot" step="0.5"
            onblur="validateHalfStep(this,'${site}',${idx},'ot')"
            onkeydown="focusNext(event,this)" placeholder="OT"></td>
          <td class="otpay">${pesoFormat(emp.otPay)}</td>
          <td class="gross">${pesoFormat(emp.gross)}</td>
          <td><input type="number" value="${emp.advance?emp.advance:''}" class="advance" step="0.01"
            oninput="updateEmployee('${site}',${idx},'advance',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td><input type="number" value="${emp.benefits?emp.benefits:''}" class="benefits" step="0.01"
            oninput="updateEmployee('${site}',${idx},'benefits',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td class="net">${pesoFormat(emp.net)}</td>
          <td style="height:40px;"></td>
          <td><button class="small danger" onclick="deleteEmployee('${site}',${idx})">Delete</button></td>
        `;
        tbody.appendChild(row);
      });

      if(site) localStorage.setItem('lastSite', site);

      computePayroll();
      saveData();
    }

    function focusNext(e,input){
      if(e.key==="Enter"){
        e.preventDefault();
        let inputs=Array.from(input.closest("tr").querySelectorAll("input,select"));
        let idx=inputs.indexOf(input);
        if(idx>=0 && idx<inputs.length-1){inputs[idx+1].focus();}
        else{input.blur();}
        computePayroll();
        saveData();
      }
    }

    function validateHalfStep(input, site, idx, field){
      let raw=input.value;
      if(raw===".") raw="0.5";
      else if(raw.startsWith(".")&&raw.length>1){raw="0"+raw;}
      let val=parseFloat(raw)||0;
      const maxDays=getMaxDays();
      val=Math.round(val*2)/2;
      if(val<0) val=0;
      if(field==="days"&&maxDays>0&&val>maxDays){
        alert("Days worked cannot exceed ("+maxDays+") days.");
        val=maxDays;
      }
      input.value=val||"";
      siteData[site][idx][field]=val;
      computePayroll();
      saveData();
    }

    function updateEmployee(site,idx,field,value){
      if(field==="role"){
        siteData[site][idx].role = cleanRole(value);
      }else{
        let num=parseFloat(value);
        if(isNaN(num)) num=0;
        if(["advance","benefits","rate"].includes(field)&&num<0) num=0;
        siteData[site][idx][field]=(field==="name"?value:num);
      }
      computePayroll();
      saveData();
    }

    function computePayroll(){
      siteTotals={};
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          const rate = Number(emp.rate)||0;
          const days = Number(emp.days)||0;
          const otH  = Number(emp.ot)||0;

          const basePay = round0(rate * days);
          const otPay   = round0((otH * rate) / 8);
          const gross   = round0(basePay + otPay);
          const deductions = round0((Number(emp.advance)||0) + (Number(emp.benefits)||0));
          const net = round0(gross - deductions);

          emp.basePay=basePay; emp.otPay=otPay; emp.gross=gross; emp.net=net;

          if(!siteTotals[site]) siteTotals[site]={gross:0,deductions:0,net:0};
          siteTotals[site].gross = round0(siteTotals[site].gross + gross);
          siteTotals[site].deductions = round0(siteTotals[site].deductions + deductions);
          siteTotals[site].net = round0(siteTotals[site].net + net);
        });
      }
      updateDashboardSummary();
      updatePerSiteSummary();
      refreshTables();
    }

    function refreshTables(){
      const site=document.getElementById("perSiteSelect").value;
      if(site&&siteData[site]){
        const rows=document.querySelectorAll("#perSiteTable tbody tr");
        rows.forEach((row,idx)=>{
          row.querySelector(".basepay").textContent=pesoFormat(siteData[site][idx].basePay||0);
          row.querySelector(".otpay").textContent=pesoFormat(siteData[site][idx].otPay||0);
          row.querySelector(".gross").textContent=pesoFormat(siteData[site][idx].gross||0);
          row.querySelector(".net").textContent=pesoFormat(siteData[site][idx].net||0);
        });
      }
    }

    function updateDashboardSummary(){
      const tbody=document.querySelector("#siteSummary tbody");
      tbody.innerHTML="";
      let gGross=0,gDed=0,gNet=0;
      for(let site in siteTotals){
        tbody.innerHTML+=`<tr>
          <td>${site}</td>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
          <td style="height:40px;"></td>
        </tr>`;
        gGross = round0(gGross + siteTotals[site].gross);
        gDed   = round0(gDed + siteTotals[site].deductions);
        gNet   = round0(gNet + siteTotals[site].net);
      }
      document.getElementById("grandGross").textContent=pesoFormat(gGross);
      document.getElementById("grandDeductions").textContent=pesoFormat(gDed);
      document.getElementById("grandNet").textContent=pesoFormat(gNet);
    }

    function updatePerSiteSummary(){
      const site=document.getElementById("perSiteSelect").value;
      const tbody=document.getElementById("perSiteSummaryBody");
      tbody.innerHTML="";
      if(siteTotals[site]){
        tbody.innerHTML=`<tr>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
        </tr>`;
      }
    }

    /* PRINT: SUMMARY */
    function printSummary(){
      computePayroll();

      const sitesList = Object.keys(siteTotals || {});
      if(sitesList.length === 0){ alert("No data to print."); return; }

      let bodyRows = "";
      let gGross=0, gDed=0, gNet=0;

      sitesList.forEach(site=>{
        const t = siteTotals[site] || {gross:0,deductions:0,net:0};
        gGross = Math.round(gGross + t.gross);
        gDed   = Math.round(gDed + t.deductions);
        gNet   = Math.round(gNet + t.net);
        bodyRows += `<tr>
          <td>${site}</td>
          <td class="num">${printPeso(t.gross)}</td>
          <td class="num">${printPeso(t.deductions)}</td>
          <td class="num">${printPeso(t.net)}</td>
          <td></td>
        </tr>`;
      });

      const from = document.getElementById("payrollFrom").value || "";
      const to   = document.getElementById("payrollTo").value || "";
      const printed = new Date().toLocaleDateString("en-PH");
      const preparedBy = (localStorage.getItem("preparedBy")||"");
      const approvedBy = (localStorage.getItem("approvedBy")||"DANA MALIWANAG");
      const logoSrc = getLogoSrc();

      const html = `
<!DOCTYPE html><html><head>
<meta charset="utf-8"><title>Payroll Summary</title>
<style>
  @media print { thead { display: table-header-group; } tfoot { display: table-row-group; } }
  @page { size: A4; margin: 12mm; }
  body { margin: 0; font-family: Arial, sans-serif; font-size: 12px; }
  .head { display:flex; align-items:center; justify-content:space-between; }
  .head .titles { text-align:left; }
  .head img.logo { height:110px; width:auto; object-fit:contain; }
  h2, h3 { margin: 4px 0; }
  .meta { text-align: left; margin: 6px 0 10px; }
  table { border-collapse: collapse; width: 100%; margin-top: 8px; }
  th, td { border: 1px solid #000; padding: 6px; page-break-inside: avoid; }
  th { background: #000; color: #fff; }
  td.num, th.num { text-align: right; }
  tfoot tr.total-row th { font-weight:bold; background:#f9f9f9; border-top:2px solid #000; }
  .sig { margin-top: 24px; display: flex; gap: 40px; justify-content: space-between; }
  .sig div { width: 48%; text-align: center; }
  .sig u { display: inline-block; min-width: 220px; }
</style>
</head><body>
  <div class="head">
    <div class="titles">
      <h2>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h2>
      <h3>Payroll Summary by Site</h3>
      <div class="meta">Payroll Period: ${from} to ${to} • Printed: ${printed}</div>
    </div>
    <img id="plogo" class="logo" src="${logoSrc}" alt="Logo">
  </div>

  <table>
    <thead>
      <tr>
        <th>Site</th>
        <th class="num">Total Gross</th>
        <th class="num">Total Deductions</th>
        <th class="num">Total Net</th>
        <th>Remarks</th>
      </tr>
    </thead>
    <tbody>${bodyRows}</tbody>
    <tfoot>
      <tr class="total-row">
        <th>GRAND TOTAL</th>
        <th class="num">${printPeso(gGross)}</th>
        <th class="num">${printPeso(gDed)}</th>
        <th class="num">${printPeso(gNet)}</th>
        <th></th>
      </tr>
    </tfoot>
  </table>

  <div class="sig">
    <div>Prepared by:<br><br><u>${preparedBy}</u><br>Signature over printed name</div>
    <div>Approved by:<br><br><u>${approvedBy}</u><br>Signature over printed name</div>
  </div>
</body></html>`;

      const win = window.open("", "_blank");
      if(!win){ alert("Pop-up blocked. Allow pop-ups to print."); return; }
      win.document.open(); win.document.write(html); win.document.close();
      const tryPrint = () => {
        try {
          const img = win.document.getElementById('plogo');
          if(!img || img.complete){ win.focus(); win.print(); return; }
          img.addEventListener('load', ()=>{ win.focus(); win.print(); });
          img.addEventListener('error', ()=>{ win.focus(); win.print(); });
        } catch {}
      };
      if(win.document.readyState === 'complete') tryPrint();
      else win.addEventListener('load', tryPrint);
    }

    /* PRINT: PER SITE — numbering resets per role */
    function printSitePayroll(){
      const site = document.getElementById("perSiteSelect").value;
      if(!site){ alert("Please select a site first."); return; }
      computePayroll();

      const list = Array.isArray(siteData[site]) ? siteData[site] : [];
      if(list.length === 0){ alert("No employees in this site."); return; }

      // Updated role order for printing
      const ROLE_ORDER = ["FOREMAN","SKILLED","SEMI-SKILLED","LABOR","CHECKER","TULOG","BANTAY"];
      const normRole = (r)=>{
        let s = (r||"LABOR").toString().trim().toUpperCase().replace(/\s+/g," ");
        if(s==="SEMI SKILLED" || s==="SEMISKILLED") s="SEMI-SKILLED";
        if(!ROLE_ORDER.includes(s)) s="LABOR";
        return s;
      };
      const fmtHalf = (x)=>{
        const v = Math.round((Number(x)||0)*2)/2;
        return Number.isInteger(v) ? String(v) : v.toFixed(1);
      };

      let bodyRows = "";

      ROLE_ORDER.forEach(role=>{
        const group = list.filter(e=>normRole(e.role)===role);
        if(!group.length) return;

        bodyRows += `<tr class="group"><td colspan="12"><strong>${role}</strong></td></tr>`;

        let roleNum = 1;

        group.forEach((emp)=>{
          const rate = Number(emp.rate)||0;
          const days = Number(emp.days)||0;
          const otH  = Number(emp.ot)||0;

          const basePay = Math.round(rate * days);
          const otPay   = Math.round((otH * rate) / 8);
          const gross   = Math.round(basePay + otPay);
          const adv     = Math.round(Number(emp.advance)||0);
          const ben     = Math.round(Number(emp.benefits)||0);
          const net     = Math.round(gross - Math.round(adv+ben));

          const n = roleNum++;

          bodyRows += `<tr>
            <td class="rownum">${n}</td>
            <td class="nameCol">${emp.name||""}</td>
            <td>${printPeso(rate)}</td>
            <td>${fmtHalf(days)}</td>
            <td>${printPeso(basePay)}</td>
            <td>${fmtHalf(otH)}</td>
            <td>${printPeso(otPay)}</td>
            <td>${printPeso(gross)}</td>
            <td>${printPeso(adv)}</td>
            <td>${printPeso(ben)}</td>
            <td>${printPeso(net)}</td>
            <td class="sigCell">
              <span class="sigNum left">${n}</span>
            </td>
          </tr>`;
        });
      });

      const totals = list.reduce((a,e)=>{
        const rate = Number(e.rate)||0;
        const days = Number(e.days)||0;
        const otH  = Number(e.ot)||0;
        const basePay = Math.round(rate * days);
        const otPay   = Math.round((otH * rate) / 8);
        const gross   = Math.round(basePay + otPay);
        const adv     = Math.round(Number(e.advance)||0);
        const ben     = Math.round(Number(e.benefits)||0);
        const net     = Math.round(gross - Math.round(adv+ben));
        return {
          days: a.days + days,
          base: a.base + basePay,
          otH:  a.otH + otH,
          otPay: a.otPay + otPay,
          gross: a.gross + gross,
          advance: a.advance + adv,
          benefits: a.benefits + ben,
          net: a.net + net
        };
      }, {days:0, base:0, otH:0, otPay:0, gross:0, advance:0, benefits:0, net:0});

      const from = document.getElementById("payrollFrom").value || "";
      const to   = document.getElementById("payrollTo").value || "";
      const preparedBy = (document.getElementById("preparedByInput").value||"").toUpperCase();
      const checkedBy  = (document.getElementById("checkedByInput").value||"").toUpperCase();
      const approvedBy = (document.getElementById("approvedByInput").value||"DANA MALIWANAG").toUpperCase();
      const logoSrc = getLogoSrc();

      const html = `
<!DOCTYPE html><html><head>
<meta charset="utf-8"><title>${site} Payroll</title>
<style>
  @media print { thead { display: table-header-group; } tfoot { display: table-row-group; } }
  body { margin: 10px; font-family: Arial, sans-serif; }
  .head { display:flex; align-items:center; justify-content:space-between; }
  .head .titles { text-align:left; }
  .head img.logo { height:110px; width:auto; object-fit:contain; }
  h2, h3 { margin: 5px 0; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #000; padding: 5px; text-align: center; page-break-inside: avoid; }
  th.nameCol, td.nameCol { white-space: nowrap; word-break: keep-all; hyphens: none; text-align:left; }
  td.rownum { width:28px; text-align:center; }
  td.sigCell { height:32px; position:relative; }
  .sigNum { position:absolute; top:4px; font-size:10px; font-weight:bold; }
  .sigNum.left { left:6px; }
  .group td { text-align:left; font-weight:bold; background:#f0f0f0; }
  tr.total-row td { font-weight:bold; background:#f9f9f9; border-top:2px solid #000; }
  .sig { margin-top: 20px; display:flex; gap:20px; justify-content: space-between; }
  .sig div { width: 32%; text-align:center; }
  .sig u { display:inline-block; min-width:220px; }
</style>
</head><body>
  <div class="head">
    <div class="titles">
      <h2>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h2>
      <h3>Payroll Report - ${site}</h3>
      <div>Payroll Period: ${from} to ${to}</div>
    </div>
    <img id="plogo" class="logo" src="${logoSrc}" alt="Logo">
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th class="nameCol">Name</th>
        <th>Rate/Day</th>
        <th>Days Worked</th>
        <th>PAY BEFORE OT</th>
        <th>OT Hours</th>
        <th>OT PAY</th>
        <th>Gross Pay</th>
        <th>Cash Advance</th>
        <th>Benefits</th>
        <th>Net Pay</th>
        <th>Signature</th>
      </tr>
    </thead>
    <tbody>
      ${bodyRows}
      <tr class="total-row">
        <td></td>
        <td>Total</td>
        <td>-</td>
        <td>${fmtHalf(totals.days)}</td>
        <td>${printPeso(totals.base)}</td>
        <td>${fmtHalf(totals.otH)}</td>
        <td>${printPeso(totals.otPay)}</td>
        <td>${printPeso(totals.gross)}</td>
        <td>${printPeso(totals.advance)}</td>
        <td>${printPeso(totals.benefits)}</td>
        <td>${printPeso(totals.net)}</td>
        <td></td>
      </tr>
    </tbody>
  </table>
  <div class="sig">
    <div>Prepared by:<br><br><u>${preparedBy}</u><br>Signature over printed name</div>
    <div>Checked by:<br><br><u>${checkedBy}</u><br>Signature over printed name</div>
    <div>Approved by:<br><br><u>${approvedBy}</u><br>Signature over printed name</div>
  </div>
</body></html>`;

      const win = window.open("", "_blank");
      if(!win){ alert("Pop-up blocked. Allow pop-ups to print."); return; }
      win.document.open(); win.document.write(html); win.document.close();

      const tryPrint = () => {
        try {
          const img = win.document.getElementById('plogo');
          if(!img || img.complete){ win.focus(); win.print(); return; }
          img.addEventListener('load', ()=>{ win.focus(); win.print(); });
          img.addEventListener('error', ()=>{ win.focus(); win.print(); });
        } catch {}
      };
      if(win.document.readyState === 'complete') tryPrint();
      else win.addEventListener('load', tryPrint);
    }

    /* CSV */
    function exportCSV(){
      computePayroll();
      let csv="Site,Name,Role,Rate,Days Worked,OT Hours,Gross,Cash Advance,Benefits,Net\n";
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          csv+=`${site},${emp.name},${cleanRole(emp.role)},${round0(emp.rate)},${emp.days},${emp.ot},${round0(emp.gross)},${round0(emp.advance)},${round0(emp.benefits)},${round0(emp.net)}\n`;
        });
      }
      const blob=new Blob([csv],{type:"text/csv"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="payroll.csv";
      link.click();
    }

    function handleCSVChange(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{ importEmployeesFromCSV(reader.result); }
        catch(err){ alert("Import failed. Check your CSV."); console.error(err); }
        e.target.value = "";
      };
      reader.readAsText(file);
    }

    function importEmployeesFromCSV(text){
      const site=document.getElementById("perSiteSelect").value;
      if(!site){ alert("Please select a site first."); return; }

      const rows = parseCSV(text).filter(r=>r.length && r.join("").trim()!=="");
      if(rows.length===0){ alert("CSV is empty."); return; }

      const header = rows[0].map(h=>String(h).trim().toLowerCase());
      let nameIdx = header.findIndex(h=>h==="name");
      let roleIdx = header.findIndex(h=>h==="role");
      let rateIdx = header.findIndex(h=>["rate/day","rate","rate per day","rate perday"].includes(h));

      let startRow = 1;
      if(nameIdx===-1 || rateIdx===-1){
        nameIdx = 0; roleIdx = 1; rateIdx = 2; startRow = 0;
      }

      const incoming = [];
      for(let i=startRow;i<rows.length;i++){
        const r = rows[i];
        const name = (r[nameIdx]||"").toString().trim().toUpperCase();
        if(!name) continue;
        const role = cleanRole(r[roleIdx]||"LABOR");
        const rate = parseMoney(r[rateIdx]);
        incoming.push({name, role, rate, days:"", ot:"", basePay:0, otPay:0, gross:0, advance:"", benefits:"", net:0});
      }
      if(incoming.length===0){ alert("No valid rows found."); return; }

      if(siteData[site]?.length){
        if(confirm("Replace current employees in this site? OK = replace, Cancel = append")){
          siteData[site] = incoming;
        }else{
          siteData[site].push(...incoming);
        }
      }else{
        siteData[site] = incoming;
      }

      renderSiteTable();
      computePayroll();
      saveData();
      alert("Import done: "+incoming.length+" employee(s).");
    }

    function parseMoney(v){
      if(v==null) return 0;
      const s = String(v).replace(/[^0-9.\-]/g,"");
      const n = parseFloat(s);
      return isNaN(n)?0:n;
    }

    function parseCSV(text){
      const out = []; let row = []; let cur = ""; let quoted = false;
      for(let i=0;i<text.length;i++){
        const c = text[i];
        if(quoted){
          if(c === '"'){
            if(text[i+1] === '"'){ cur += '"'; i++; }
            else { quoted = false; }
          }else{ cur += c; }
        }else{
          if(c === '"'){ quoted = true; }
          else if(c === ','){ row.push(cur); cur=""; }
          else if(c === '\n' || c === '\r'){
            if(c === '\r' && text[i+1] === '\n') i++;
            row.push(cur); cur=""; out.push(row); row=[];
          }else{ cur += c; }
        }
      }
      row.push(cur); out.push(row);
      return out;
    }
  </script>
</body>
</html>
